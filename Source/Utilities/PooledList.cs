namespace Universal_Lift_Structure;

// ============================================================
// 【池化集合包装器】
// ============================================================
// 此文件提供了两个 ref struct 包装器，用于简化 SimplePool 的使用
//
// 【核心功能】
// 1. PooledList<T>：自动管理 List<T> 的租借和归还
// 2. PooledHashSet<T>：自动管理 HashSet<T> 的租借和归还
//
// 【ref struct 特性】
// - 只能在栈上分配，不能装箱到堆
// - 不能作为类的字段（只能是局部变量或方法参数）
// - 不能在异步方法或迭代器中使用
// - 配合 using 语句实现确定性资源释放（类似 C++ RAII）
//
// 【使用方式】
// using (new PooledList<int>(out var list))
// {
//     list.Add(1);
//     list.Add(2);
//     // 自动在作用域结束时归还到池
// }
//
// 【性能优势】
// - 避免频繁的 GC 分配：复用已有集合实例
// - 自动清理：Dispose() 自动清空集合并归还，防止内存泄漏
// - 零开销：ref struct 在栈上分配，无 GC 压力
// ============================================================

// ============================================================
// 【PooledList<T> - 池化列表包装器】
// ============================================================
// 通过 using 语句自动管理 List<T> 的生命周期
//
// 【典型用途】
// - 临时集合操作：需要一个临时列表进行计算后丢弃
// - 高频调用场景：避免每次都 new List<T>() 产生 GC 压力
// ============================================================
public readonly ref struct PooledList<T>
{
    // 从对象池中获取的列表实例
    // readonly 确保引用不可变（但列表内容可变）
    public readonly List<T> List;

    // ============================================================
    // 【构造函数】
    // ============================================================
    // 从 SimplePool 中租借一个列表实例，并通过 out 参数返回
    //
    // 【参数】
    // - out list：返回的列表引用（与 List 字段指向同一实例）
    //
    // 【实现细节】
    // 1. SimplePool<List<T>>.Get()：从对象池获取或创建新实例
    // 2. List.Clear()：清空列表内容（池中的列表可能有残留数据）
    // 3. list = List：通过 out 参数返回引用，方便调用方使用
    // ============================================================
    public PooledList(out List<T> list)
    {
        // 从对象池获取列表实例
        List = SimplePool<List<T>>.Get();
        // 清空列表（池中的实例可能有残留数据）
        List.Clear();
        // 通过 out 参数返回列表引用
        list = List;
    }

    // ============================================================
    // 【释放方法】
    // ============================================================
    // 在 using 块结束时自动调用，归还列表到对象池
    //
    // 【工作流程】
    // 1. 清空列表内容（避免持有无效引用）
    // 2. 归还列表到对象池供后续复用
    //
    // 【重要】
    // - 必须清空列表，否则会导致内存泄漏
    // - 归还后不应再使用 List，否则可能导致数据污染
    // ============================================================
    public void Dispose()
    {
        // 清空列表内容（防止旧引用泄漏）
        List.Clear();
        // 归还到对象池
        SimplePool<List<T>>.Return(List);
    }
}

// ============================================================
// 【PooledHashSet<T> - 池化哈希集合包装器】
// ============================================================
// HashSet 版本的对象池包装器，用于去重和快速查找场景
//
// 【与 PooledList<T> 的区别】
// - HashSet：无序、去重、O(1) 查找
// - List：有序、允许重复、O(n) 查找
//
// 【典型用途】
// - 去重操作：快速去除重复元素
// - 成员检查：判断元素是否存在
// ============================================================
public readonly ref struct PooledHashSet<T>
{
    // 从对象池中获取的哈希集合实例
    public readonly HashSet<T> Set;

    // ============================================================
    // 【构造函数】
    // ============================================================
    // 从 SimplePool 中租借一个 HashSet 实例
    // ============================================================
    public PooledHashSet(out HashSet<T> set)
    {
        // 从对象池获取 HashSet 实例
        Set = SimplePool<HashSet<T>>.Get();
        // 清空集合内容
        Set.Clear();
        // 通过 out 参数返回集合引用
        set = Set;
    }

    // ============================================================
    // 【释放方法】
    // ============================================================
    // 在 using 块结束时自动调用，归还集合到对象池
    // ============================================================
    public void Dispose()
    {
        // 清空集合内容
        Set.Clear();
        // 归还到对象池
        SimplePool<HashSet<T>>.Return(Set);
    }
}
